# db-study
> [NoSQL 철저 입문](https://book.naver.com/bookdb/book_detail.nhn?bid=9956311)  

* 관계형 데이터베이스  
    관계형 데이터베이스는 데이터와 데이터 간의 관계를 묘사하기 위해 관계형 대수학을 사용하는 형식 수학 모델에 기반을 두고 있으며 데이터 구조의 논리 구성을 물리적인 저장 구조와 분리했다.  
* 관계형 데이터베이스 관리 시스템(RDBMS)  
    데이터를 관리하고 애플리케이션 사용자들이 데이터를 읽고 추가/갱신/삭제하는 것을 허용하는 다수의 프로그램으로 구성된 애플리케이션이다. 이전 데이터베이스 모델에서는 데이터를 사용하기 위해 매번 프로그램을 개발해야했던 것과는 달리 RDBMS에서는 SQL이라는 공통 언어를 사용한다.    

    * 관계형 데이터베이스 관리 시스템의 구조  
        RDBMS를 구현하기 위한 최소 요구 사항 4가지가 합쳐져 RDBMS의 핵심 데이터 관리와 데이터 조회 서비스를 제공한다.   

        1. 스토리지 관리 프로그램  
            데이터베이스 시스템은 장기기억 저장 장치로 디스크와 플래시 드라이브에 데이터를 저장한다. 어떤 유형의 저장 시스템이 사용되든 RDBMS는 데이터 조각이 저장된 위치 하나하나를 모두 추척해야한다. 테이프 기반 스토리지에서는 데이터를 검색할 때 순차적으로 찾아야했지만 디스크와 플래시 드라이브는 그런 제약이 없기 때문에 RDBMS 설계자들은 인덱스를 생성하여 데이터 조회 방식을 개선했다. **인덱스**란 데이터베이스에 저장된 데이터 블록의 위치 정보를 포함하는 데이터 집합을 말한다.  
            데이터 위치를 추적하는 것 외에도 데이터 위치를 최적화하고, 데이터를 압축하여 저장 공간을 절약하고, 데이터 블록을 복사해서 디스크 결함으로 데이터 블록이 소실되지 않도록 예방한다.  

        2. 메모리 관리 프로그램  
            RDBMS는 메모리에서 데이터를 관리하는 책임도 있다. 메모리 관리 요소는 필요한 경우에 데이터를 메모리로 가져와 유지하고, 더는 필요하지 않을 때 메모리에서 삭제하거나 추가 데이터가 저장될 공간을 마련하는 일을 수행한다. 메모리에서 데이터를 읽어 들이는 것이 디스크에서 읽어 들어것 보다 횔씬 빠르고, 메모리를 효율적이고 효과적으로 사용하느냐에 따라 RDBMS의 전체 성능이 크게 좌우된다.  

        3. 데이터 사전  
            데이터 사전은 데이터베이스에 저장된 데이터 구조 정보를 추적하는 RDBMS의 한 부분이다. 데이터 사전은 데이터베이스를 구성하는 스키마, 테이블, 컬럼, 인덱스, 제약조건, 뷰에 대한 정보를 포함한다.  

            * `스키마` : 테이블, 뷰, 인덱스, 데이터 집합에 대한 구조이며 독립된 애플리케이션의 주요 유형에 따라 스키마를 분리하는 것이 일반적이다.     
            * `테이블` : 엔티티 데이터를 담고 있는 데이버베이스 구조이다. 엔티티는 RDBMS가 지원하는 작업이나 비지니스와 연관된 물리적, 혹은 논리적인 실체를 묘사한다.  
            테이블은 컬럼으로 구성된다. 컬럼에는 한 단위의 정보가 포함되어 있으며 저장된 데이터가 어떤 유형인지 파악하기 위해 데이터 타입 정보를 갖고 있다.  
            * `인덱스` : 데이터베이스에 저장된 데이터 블록의 위치 정보를 포함하는 데이터 집합으로 데이터 조회 속도를 향상시킨다.  
            * `제약 조건` : 컬럼에 들어가는 데이터값을 제한하는 규칙을 말한다. 제약 조건은 데이터 표현 방식과 엔티티에 대한 비지니스 규칙을 기준으로 만드는 것이 일반적이다.  
            * `뷰` : 하나 이상의 테이블에서 관련된 컬럼이나 컬럼에 있는 데이터에 대한 계산한 값들을 모아놓은 것이다. 뷰는 사용자가 볼 수 있는 데이터에 제한을 두는 용도나 여러 테이블의 데이터를 결합해 하나의 뷰로 만들어 보여주는 용도로 사용될 수 있다.   

        4. 질의 언어  
            RDBMS의 질의 언어는 두 가지 유형의 동작을 수행하는데, 하나는 데이터 구조를 정의하는 것이고(CREATE, ALTER, DROP, ...), 다른 하나는 데이터를 조작하는 것(SELECT, UPDATE, DELETE, INSERT)이다.  
* RDBMS를 사용하는 애플리케이션의 구조  
    * 사용자 인터페이스 : 사용자의 작업 처리를 지원한다.  
    * 비지니스 로직 : 계산을 수행하고 비지니스 규칙을 확인하는 프로그램의 한 부분이다.  
    * 데이터베이스 코드 : SQL을 말하며 사용자가 사용자 인터페이스로 수행하는 작업에 따라 사용하는 문장이 달라진다.  

* 관계형 데이터베이스의 한계  
    웹의 출현으로 관계형 데이터베이스의 한계가 문제로 드러나게 되었다. 상당히 큰 규모의 데이터와 극도로 많은 수의 사용자를 대상으로 작업하는 웹 애플리케이션 개발자는 대용량 데이터의 읽기와 쓰기 작업, 빠른 응답 시간, 높은 가용성을 지원해야하는데 이런 것들을 관계형 데이터베이스로 실현하기가 어려웠다.  

* 대용량 데이터 관리 작업에서 중요한 네 가지 특징  
    1. **확장성**  
        확장성은 변화무쌍한 작업 부하에 대한 요구 사항을 효율적으로 충족시키는 능력이다.  
        트랙픽 부하로 서버를 늘리거나 줄일 수 있는데 이런 것을 **스케일 아웃**이라고 한다. 관계형 데이터베이스에서 스케일 아웃은 여러 서버를 관리해야하는 것과 같은 복잡성과 운영 비용이 증가하는 문제를 일으킬 수 있다.  
        기존 데이터베이스 서버에 프로세서, 메모리, 네트워크 대역폭을 추가하거나 데이터베이스 관리 시스템의 성능을 향상시키는 다른 자원을 추가하여 기존 데이터베이스 서버를 업그레이드하는 **스케일 업** 방법도 있다.  
        상황에 따라 서버를 추가하거나 제거하는 스케일 아웃이 스케일 업보다 더 유연한 방법이다. NoSQL 데이터베이스는 관리자의 간섭을 최소한으로 하며 클러스터 하나에 서버 여러 개를 이용하도록 설계되었다.새로운 서버를 추가하거나 제거하면서 NoSQL 데이터베이스 관리 시스템은 사용 가능한 새 서버를 사용하도록 조정한다.  
        서버를 교체하는 방식을 사용하면 데이터베이스 관리를 새 서버로 마이그레이션해야 한다. 여러 자원을 추가하는 방식을 사용하면 마이그레이션이 필요없지만, 데이터베이스 서버에 하드웨어를 추가하는 동안 운영 중지 시간<sub>downtime</sub>이 발생한다.  

    2. **비용**  
        상용 소프트웨어 벤더는 RDBMS를 운영하는 서버 용량, 동시 접속자 수, 해당 소프트웨어 사용 허가를 받은 사용자 수에 따라 과금하는 다양한 라이선스 모델이 있다.  
        NoSQL 데이터베이스들은 주로 오픈소스 소프트웨어 이며 서드파티 회사들이 오픈 소스 NoSQL 데이터베이스 상용 지원 서비스를 제공하고 있다.  

    3. **유연성**  
        기존 산업에서 관계형 데이터베이스는 관계형 모델을 사용해 해결할 수 있는 문제 범위 내에서는 유연한 편이었다. 하지만 관계형 데이터베이스는 프로젝트를 시작할 때부터 애플리케이션 지원에 필요한 모든 테이블과 컬럼을 파악해야하고 대부분의 테이블에 값이 채워져있다. 이런 면에서 관계형 데이터베이스는 유연성이 부족하다.  
        관계형 데이터베이스와는 달리 일부 NoSQL 데이터베이스는 고정된 테이블 구조가 필요하지 않다.  

    4. **가용성**  
        원할 때 언제든지 이용할 수 있는 서비스를 가용성이 높은 서비스라고 한다.  
        NoSQL 데이터베이스는 저렴한 비용으로 서버를 여러 개 이용할 수 있도록 설계되었다. 서버 하나가 중지되거나 유지보수 목적으로 서비스가 불가능할 때 같은 클러스터에 있는 다른 서버가 작업량 전체를 떠맡을 수 있다.  
        단일 서버로 구성된 서비스에 문제가 생겨 중지됐을 때 백업 서버가 있다면 백업 서버가 주 서버가 처리하던 데이터를 받아와 작업을 이어나갈 수 있다. 이러한 구성은 매우 비효율적인데, 주 서버에 문제가 발생하지 않는다면 백업 서버는 작업 처리에 아무런 도움이 되지 않기 때문이다.  

* 분산 데이터베이스에서의 데이터 관리  
    * 일반적인 데이터베이스에서 데이터를 조회하고 저장하기 위해서 세 가지 기능을 수행해야 한다.  
        1. 영구적인 데이터 저장  
            데이터베이스 서버가 고장나더라도 데이터는 소실되지 않고 저장되어야 한다  
        2. 데이터 일관성 유지  
            스토리지에 올바른 데이터가 저장되었지 확인하는 것은 매우 중요하다. 흔히 둘 이상의 사람이 데이터베이스를 사용하면서 같은 데이터를 사용하고자 할 때 읽기와 쓰기에 관한 이슈가 발생한다. 관계형 데이터베이스 시스템은 이런 식으로 여러 단계에 걸쳐 일어나는 과정을 단일 작업처럼, 혹은 단일 트랜잭션으로 처리하도록 설계되었다.  
        3. 데이터 가용성 확보  
            데이터는 필요할 때면 언제든지 사용할 수 있어야 하지만 이를 보장하기는 쉽지 않다. 데이터베이스 서버를 이용할 수 없는 상황을 피하는 한 가지 방법은 두 대의 데이터베이스 서버를 운용하는 것이다. 주 서버와 백업 서버를 이용해 운용할 수 있으며 주로 주 서버를 데이터를 갱신하고 요청 질의에 응답하는데 사용하다가 문제가 생겼을때 백업 서버를 사용하는 것이다. 주 서버에서 사용하는 디스크에 변경사항이 발생하면 해당 디스크에 반영하고 백업 서버에서 사용하는 디스크에도 동일하게 변경사항을 반영한다. 이를 2단계 컷밋(2PC, Two-Phase Commit)이라고 한다.  
            트랜잭션은 여러 단계로 구성되어있으며 하나의 단계라도 실패하게 되면 전체 트랜잭션은 실패한다. 주 서버 디스크에 갱신을 완료했지만 백업 서버에 갱신을 실패하게 되면 주 서버 디스크는 다시 복원되어야 하며, 이것이 2단계 커밋의 예이다. 이렇게 주 서버 디스크의 데이터와 백업 서버 디스크의 데이터는 일관성을 유지해야 한다.
            주 서버에 문제가 생겨 가동을 멈추고 백업 서버를 가동하면서 발생한 데이터 변경사항은 주 서버를 가동하기 전에 백업 서버에서 발생한 변경사항을 주 서버에 적용해야한다. 이렇게 데이터 일관성이 유지된 후에야 주 서버를 사용할 수 있다.  
            두 대의 서버를 운용하면 하나의 서버에 문제가 생겼을 때 다른 서버를 사용할 수 있는 장점이 있지만 그만큼 비용문제가 발생한다. 또한 데이터베이스 애플리케이션과 사용자는 데이터 쓰기가 완료될 때까지 기다려야하는 단점도 있다. 2단계 커밋의 경우 두 대의 데이터베이스 서버에 쓰기 작업을 완료해야하기 때문에 갱신 작업의 속도는 데이터의 양과 디스크 속도, 두 서버간의 네트워크 속도, 다른 설계 요소에 따라 달라진다.  
            고가용성을 보장하는 환경에서 일관성과 가용성은 트랜잭션을 완료하는 데 더 긴 시간이 필요한다.  
            **데이터베이스 트랙잭션의 일관성** : 논리적으로 일관된 단일 데이터를 유지함을 의미한다. 데이터 일관성과는 다른 개념.  
            **분산 데이터베이스에서 가용성과 일관성** : 서버 여러 대를 사용하는 데이터베이스 관리 시스템을 운영하다 보면 일관성과 고가용성을 유지하기 위해 시간이 걸리는 문제가 발생한다. 어떤 애플리케이션에서는 일관성보다는 빠른 데이터베이스 연산을 해야하는 경우가 있다. 예를 들어 전자 상거래 사이트에서 사용자가 장바구니에 상품을 추가했다면 두 대의 서버에 있는 장바구니에 똑같은 상품이 담겨있어야 한다. 하지만 두 서버의 데이터 일관성을 유지하는데 발생하는 시간때문에 사용자 인터페이스가 느리다고 느낄 수 있게 된다. 이 문제를 해결하기 위한 한 가지 방법은 하나의 서버에 데이터 갱신이 완료되면 데이터가 저장되었다는 사실을 통보하는 것이다. 이 사실을 고객이 통보받는 동안 다른 서버에 쓰기 작업을 수행하면 된다. 두 서버의 장바구니 데이터가 일치하지 않는 시간이 매우 짧으므로 고객은 쇼핑을 계속 이어나갈 수 있다. 결국에는 두 서버의 장바구니 데이터가 같아질 것을 알기때문에 짧은 시간 동안 데이터가 일치하지 않는 것은 기꺼이 감수할 수 있으며 시스템 효율에 불리한 영향을 주지는 않는다.  
    * 응답시간/일관성/지속성 간의 균형 맞추기  
        NoSQL 데이터베이스는 **결과적 일관성<sub>eventual consistency</sub>**을 구현한다. 즉, 데이터 복사본들이 다른 값을 갖는 시기가 있지만 결국 모든 복사본이 같은 값을 갖게 된다는 뜻이다. 이때, 데이터 복사본들이 다른 값을 갖는 시기에 하나의 클러스터에 있는 다른 데이터베이스에서 다른 결괏값을 받아 볼 가능성이 있다. 관계형 데이터베이스와 엄격한 일관성이 보장되는 환경이 아니기에 간단한 문제가 아니다.  
        **쿼럼quorum** : 완료되었다고 여겨지는 읽기나 쓰기 작업에 반드시 응답해야 하는 서버의 수를 말하며 NoSQL 데이터베이스에서 사용되는 개념이다.  
        서버 여러 대에서 읽기 작업을 할 때 올바른 응답을 하는 한 가지 방법은 해당 데이터가 저장된 모든 서버에 질의를 하는 것이다. 이렇게 하면 데이터베이스는 반환되는 응답값 중 유일한 응답값의 수를 세어 구성임계값<sub>configure threshold</sub>과 같거나 이를 초과하는 응답값을 반환한다. 예를 들어 NoSQL 데이터베이스에 있는 데이터가 서버 5대로 복제되었고 읽기 임계값을 3으로 설정했다면, 서버 3대가 같은 응답을 하자마자 결과가 사용자에게 반환된다.  
        이럴때 읽기 임계값을 낮출수록 빠른 응답을 받을 수 있지만 일관성이 깨진 데이터가 반환될 위험이 커진다. 임계값을 높일수록 일관성이 보장된 데이터를 받을 수 있지만 응답 시간은 길어질 것이다.  
        **지속성<sub>durability</sub>**이란 긴 기간 동안 올바른 데이터 복사본을 유지하는 속성을 말한다. 이 경우 쓰기 작업은 스토리지에 최소 개수의 복제본이 저장되었을 때 완료된 것으로 본다. 예를 들어 서버 5대로 운영될 때, 먄약 서버 3대에 데이터가 복제되고 쓰기 임계값을 3으로 설정한다면 복사본 3개는 쓰기 작업이 완료되기 전에 스토리지에 기록될 것이다. 임계값을 2로 설정하면 쓰기 작업이 완료되기 전에 서버 2개로 데이터가 복제되고 세 번째 복사본은 나중에 기록될 것이다. 지속성을 위해 쓰기 임계값을 최소 2로 설정하고 2보다 많은 수의 복제 서버를 운용하면 쓰기 작업에 대한 응답 시간은 늘어나지 않으면서도 지속성을 향상하는 데 도움이 된다.  
    * CAP 이론 : 일관성, 가용성, 파티셔닝  
        CAP 이론은 분산 데이터베이스는 일관성(C), 가용성(A) 그리고 파티션 허용(P), 이 세 가지 속성을 동시에 가질 수 없다는 내용이다. 여기에서 말하는 **일관성<sub>Consistency</sub>**은 서버 간에 일관된 데이터를 유지하는 것을 말하고, **가용성<sub>Availability</sub>**은 질의에 대한 응답을 제공하는 것을 말하고, **파티션 허용<sub>Partition protection</sub>**은 둘 이상의 데이터베이스 서버가 연결된 네트워크에 문제가 생기더라도 이 서버들은 여전히 일관된 데이터를 갖는 것을 말한다.  
        일관성을 갖지 못하는 경우 : 주 서버에 문제가 생겨 백업 서버를 사용하는 경우  
        가용성을 갖지 못하는 경우 : 2단계 커밋을 사용해 변경사항 반영 작업 처리 시간이 길어지는 경우  
        파티션 허용은 서버끼리 통신하지 못하는 상황을 처리한다. **파티셔닝<sub>partitioning</sub>**이란 서로 통신할 수 없는 장치와 통신할 수 있는 장치를 네트워크에서 분리하는 것을 말한다. CAP 이론에서 파티셔닝은 데이터베이스 서버 간에 메시지를 전송할 수 없는 상태와 관련이 있다. 만약 분산 데이터베이스를 운영하는 데이터베이스 서버가 네트워크 이상으로 파티셔닝된 상태라면 질의에 응답하고 가용성을 보존할 수는 있겠지만 데이터가 일치하지 않을 위험이 생긴다. 이와 달리 서버 한 대를 무력화하고 다른 서버 한 대만 질의에 응답할 수 있게하면 사용자에게 일치되지 않은 데이터를 반환하는 일은 피할 수 있지만 일부 사용자의 가용성은 희생된다.  
        실용적인 측면에서 데이터베이스 애플리케이션 설계자는 LAN 환경에서 네트워크 파티션이 드물게 일어나기 때문에 일관성과 가용성 사이에서 균형을 잡도록 설계해야 한다.  
        NoSQL 데이터베이스 관리 시스템 설계자는 일관성, 가용성, 파티셔닝 보호, 이 세 가지 측면에서 모든 사용자에게 단 한 가지 선택권을 제공하기보다는 데이터베이스 사용자가 선호하는 방식을 스스로 설정할 수 있도록 허용하는 구성체계를 제공하는 것이 좋다.  

* **ACID** : 관계형 데이터베이스는 ACID 트랜잭션을 지원하도록 설계되었다.  
    * **원자성<sub>Atomicity</sub>**  
        더는 분할되지 않는 단위. 트랜잭션은 여러 단계로 이루어져 있는데, 핵심은 각 단계들을 분발해서 생각하면 안된다. 모든 단계가 완료되거나 모든 단계가 완료되지 않도록 해야 한다.  
    * **일관성<sub>Consistency</sub>**  
        관계형 데이터베이스에서는 엄격한 일관성이라고 한다. 다른 말로 풀어 설명하면 트랜잭션은 데이터의 무결성을 위반한 상태로 데이터베이스를 내버려 두지 않는다는 뜻.  
        예를 들어, A 계좌에서 B 계좌로 100만원을 이체한다고 했을 때, (a) B계좌에서 100만원을 더하고 A계좌에서 100만원을 빼거나, (b) A계좌와 B계좌가 트랜잭션이 시작된 시점의 같은 금액을 가진 상태로 종료되어야 한다. (a),(b) 두 상태를 제외한 다른 상태는 가능하지 않도록 보증하는 것이 일관성이다.  
    * **고립성<sub>Isolation</sub>**  
        고립된 트랜잭션은 완료되기 전까지 다른 사용자들에게 보이지 않는다.  
    * **지속성<sub>durability</sub>**  
        일단 한 트랜잭션이나 작업 하나가 완료되면 서버에 전원공급이 끊어지는 상황에서도 데이터가 완료된 상태로 남아 있음을 의미한다.  

* **BASE** : NoSQL 데이터베이스는 BASE 트랜잭션을 지원하며, 일정 수준에서 ACID 트랜잭션을 지원하기도 한다.  
    * **기본적인 가용성<sub>Basically Available</sub>**  
        분산 시스템에서 부분적인 고장이나 실패는 있을 수 있지만, 시스템의 나머지 부분은 계속 기능을 수행한다는 의미다.  
    * **소프트 상태<sub>Soft State</sub>**  
        컴퓨터 과학에서 소프트 상태란 사용자가 시스템에 넣은 정보(데이터)를 유지보수하지 않는다면 그 정보는 없어지는 것을 말한다. 다른 말로 설명하자면 정보가 갱신이 안 된다면 만료되는 것을 말한다.  
        NoSQL 데이터베이스에서 소프트 상태란 결국 데이터가 더 최신 상태인 데이터로 덮여 쓰이는 것을 의미한다.  
    * **결과적 일관성<sub>Eventually Consistency</sub>**  
        데이터베이스가 일관성이 없는 상태가 될 때가 있음을 의미한다. NoSQL 데이터베이스는 서버 여러 대에 데이터 복사본을 두고 관리하기 때문에 어느 프로그램이 복사본 하나를 갱신하는 동안 다른 복사본에 이전 버전의 데이터가 있을 수 있다. NoSQL 데이터베이스의 복사 메커니즘은 모든 복사복을 갱신하겠지만, 한동안 복사본이 일치하지 않을 것이다.  
        * 결과적 일관성의 유형  
            * **인과적 일관성**  
                데이터베이스가 작업이 갱신된 순서를 보장하는 것을 말한다.  
            * **최신 데이터 읽기 일관성**  
                레코드 하나를 갱신했다면 이 레코드에 대한 모든 질의(읽기)는 갱신된 값을 반환하는 것을 말한다.  
            * **세션 일관성**  
                세션이 살아있는 동안 최신 데이터 읽기 일관성을 보장하는 것을 말한다.  
                세션이란 클라이언트와 서버간의 대화라고 생각하면 되고, 사용자와 데이터베이스 간의 대화가 지속되는 동안 데이터베이스는 대화 중 수행했던 모든 읽기 작업을 기억하고 있다. 만약 세션을 종료하고 다른 세션을 연결했다면 이전 세션에서 수행한 내역을 기억할거라고 보장 할 수 없다. 세션은 데이터베이스 애플리케이션에서 로그아웃하면 종료되고, 일정 시간 이상 대화가 없으면 데이터베이스는 더이상 이 세션이 필요하지 않다고 판단해 세션을 종료한다.  
            * **단조 읽기 일관성**  
                질의를 해서 그 결과를 볼 때 해당 값의 이전 버전은 절대 볼 수 없다는 뜻이다. 어떤 데이터를 갱신했을 때, 그 데이터의 복사본이 있는 모든 서버가 갱신되지 않았더라도 해당 데이터를 질의했을 때 데이터의 최신 정보를 알 수 있다.  
            * **단조 쓰기 일관성**  
                몇 개의 갱신 명령어를 실행했을 때 이 명령어들이 실행된 순서대로 처리되는 것을 말한다. 데이터베이스가 작업 순서를 보장하는 것은 중요한 특성이다.  
